# sync_ntuples ----------------------------------------------------------------
#    This rule downloads all files corresponding to a given VERSION from EOS
#    to SAMPLES_PATH/VERSION folder. It requires you to make a kinit on your
#    system, and then it work automatically. It takes a bit long.

rule sync_ntuples:
  output:
    sample = SAMPLES_PATH+'{year}/{mode}/{version}_sWeight.root'
  log:
    'output/log/samples/sync_ntuples/{year}/{mode}/{version}.log'
  run:
    import os
    #     print(f"""
    # +------------------------------------------------------------------------------+
    # | ····································**************************************** |
    # | ···································***************************************** |
    # | ·····························÷÷÷÷÷÷÷÷÷÷************************************* |
    # | ························÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷*********************************** |
    # | ······················÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷********************************* |
    # | ····················÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷******************************** |
    # | ····················÷÷÷÷÷÷÷÷÷÷÷÷÷÷|÷÷÷÷÷÷÷÷÷÷******************************* |
    # | ···················÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷|÷÷÷÷÷÷÷÷÷÷%%%**************************** |
    # | ···················÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷|÷÷÷÷÷÷÷÷÷÷%%%%%%%************************ |
    # | ···················÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷|÷÷÷÷÷÷÷÷÷÷%%%%%%%%%%********************* |
    # | ···················÷÷÷÷÷÷÷÷÷÷÷÷÷//|//÷÷÷÷÷÷÷%%%%%%%%%%%%%%****************** |
    # | ····················÷÷÷÷÷÷÷÷÷÷÷///|///÷÷÷÷÷%%%%%%%%%%%%%%%%***************** |
    # | ·····················÷÷÷÷÷÷÷÷÷//##|////÷÷÷%%%%%%%%%%%%%%%%%%%%************** |
    # | ·················%%%%%%÷÷÷÷÷÷÷÷###|#//÷÷%%%%%%%%%%%%%%%%%%%%%%%************* |
    # | ··············%%%%%%%%%%%%%%''''##|'%%%%%%%%%%%%%%%%%%%%%%%%%%************** |
    # | ·········%%%%%%%%%%%%%%%%%''''''''|'''%%%%%%%%%%%%%%%%%%%%%%%%%************* |
    # | ···%%%%%%%%%%%%%%%%%%%%%%%''''''''''''%%%%%%%%%%%%%%%%%%%%%%%%%************* |
    # | %%%%%%%%%%%%%%%%%%%%%%%%%%%%'''''''%%%%%%%%%%%%%%%%%%%%%%%%%%%************** |
    # | %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*************** |
    # | %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%***************** |
    # +------------------------------------------------------------------------------+
    #
    #                                    phis-SCQ
    #
    #     """)
    #print(f'{params.sample}')
    if not os.path.exists(f"output.sample"):
      v = f'{wildcards.version}'
      y = f'{wildcards.year}'
      m = f'{wildcards.mode}'
      eos_path  = f'/eos/lhcb/wg/B2CC/Bs2JpsiPhi-FullRun2'
      eos_path += f'/{v}/{m}/{y}/{m}_{y}_selected_bdt_sw_{v}.root'
      scq_path  = SAMPLES_PATH+f'{y}/{m}/{v}_sWeight.root'
      shell(f"""
        (time\
        echo "
+------------------------------------------------------------------------------+
| ····································**************************************** |
| ···································***************************************** |
| ·····························÷÷÷÷÷÷÷÷÷÷************************************* |
| ························÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷*********************************** |
| ······················÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷********************************* |
| ····················÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷******************************** |
| ····················÷÷÷÷÷÷÷÷÷÷÷÷÷÷|÷÷÷÷÷÷÷÷÷÷******************************* |
| ···················÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷|÷÷÷÷÷÷÷÷÷÷%%%**************************** |
| ···················÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷|÷÷÷÷÷÷÷÷÷÷%%%%%%%************************ |
| ···················÷÷÷÷÷÷÷÷÷÷÷÷÷÷÷|÷÷÷÷÷÷÷÷÷÷%%%%%%%%%%********************* |
| ···················÷÷÷÷÷÷÷÷÷÷÷÷÷//|//÷÷÷÷÷÷÷%%%%%%%%%%%%%%****************** |
| ····················÷÷÷÷÷÷÷÷÷÷÷///|///÷÷÷÷÷%%%%%%%%%%%%%%%%***************** |
| ·····················÷÷÷÷÷÷÷÷÷//##|////÷÷÷%%%%%%%%%%%%%%%%%%%%************** |
| ·················%%%%%%÷÷÷÷÷÷÷÷###|#//÷÷%%%%%%%%%%%%%%%%%%%%%%%************* |
| ··············%%%%%%%%%%%%%%''''##|'%%%%%%%%%%%%%%%%%%%%%%%%%%************** |
| ·········%%%%%%%%%%%%%%%%%''''''''|'''%%%%%%%%%%%%%%%%%%%%%%%%%************* |
| ···%%%%%%%%%%%%%%%%%%%%%%%''''''''''''%%%%%%%%%%%%%%%%%%%%%%%%%************* |
| %%%%%%%%%%%%%%%%%%%%%%%%%%%%'''''''%%%%%%%%%%%%%%%%%%%%%%%%%%%************** |
| %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*************** |
| %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%***************** |
+------------------------------------------------------------------------------+
      " && scp lxplus:{eos_path} {scq_path}
      ) &> {log} #2>&1 """)



# reduce_ntuples ---------------------------------------------------------------
#    Reduces the amount of branches in the original ntuples. This rule builds
#    the ntuples that will actually be used for phis-scq analysis package.

rule reduce_ntuples:
  input:
    sample = lambda wcs: tuples(wcs, weight='kinWeight')
  output:
    sample = SAMPLES_PATH+'{year}/{mode}/{version,[A-Za-z0-9]+}.root'
  log:
    'output/log/samples/reduce_ntuples/{year}_{mode}_{version}.log'
  run:
    shell(f"""
      (time\
      python samples/reduce_ntuples.py\
             --input-file {input.sample}\
             --output-file {output.sample}\
             --input-tree DecayTree\
             --output-tree DecayTree\
      ) &> {log} #2>&1
    """)
    # shell(f"""
    #   rm {SAMPLES_PATH}{wildcards.year}/{wildcards.mode}/{wildcards.version}_*Weight.root
    # """)
