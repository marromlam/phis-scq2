#---

# naive angular acceptance - no correction (only sWeight and polWeight) --------
#     Here we have 2 rules to compute angular acceptance without correcting
#     MC samples. First rule computes angular acceptance for MC, and second one
#     merges MC results to compute RD angular acceptance
rule angular_acceptance_naive:
  resources:
    mem_mb = 4096
  wildcard_constraints:
    mode = "(TOY|MC)_(Bs2JpsiPhi|Bd2JpsiKstar)(_dG0)?",
    angacc = "naive.*"
  input:
    sample = lambda wcs: tuples(wcs),
  params:
    params = 'analysis/params/generator/{year}/{mode}.json'
  output:
    params = 'output/params/angular_acceptance/{year}/{mode}/{version}_{angacc}_{trigger}.json',
    tables = 'output/tables/angular_acceptance/{year}/{mode}/{version}_{angacc}_{trigger}.tex'
  log:
    'output/log/angular_acceptance_naive/{year}/{mode}/{version}_{angacc}_{trigger}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/naive.py\
           --sample {input.sample}\
           --input-params {params.params}\
           --output-params {output.params}\
           --output-tables {output.tables}\
           --year {wildcards.year}\
           --mode {wildcards.mode}\
           --version {wildcards.version}\
           --angacc {wildcards.angacc}\
           --trigger {wildcards.trigger}
    ) &> {log}""")
    send_mail(f"Angular Acceptance Naive :: {wildcards}", f"{log}")


# blend angular acceptance - no correction (only sWeight and polWeight) --------
#     Here we have 2 rules to compute angular acceptance without correcting
#     MC samples. First rule computes angular acceptance for MC, and second one
#     merges MC results to compute RD angular acceptance
rule angular_acceptance_blend:
  resources:
    mem_mb = 512
  wildcard_constraints:
    step = "(naive|corrected).*",
    #version = "^((?!v0r1).)*$",
  input:
    weights_std = 'output/params/angular_acceptance/{year}/MC_Bs2JpsiPhi/{version}_{step}_{trigger}.json',
    weights_dg0 = 'output/params/angular_acceptance/{year}/MC_Bs2JpsiPhi_dG0/{version}_{step}_{trigger}.json',
  output:
    params = 'output/params/angular_acceptance/{year}/Bs2JpsiPhi/{version}_{step}_{trigger}.json',
    tables = 'output/tables/angular_acceptance/{year}/Bs2JpsiPhi/{version}_{step}_{trigger}.tex'
  log:
    'output/log/angular_acceptance_blend/{year}/Bs2JpsiPhi/{version}_{step}_{trigger}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/merge.py\
           --weights-std {input.weights_std}\
           --weights-dg0 {input.weights_dg0}\
           --output-params {output.params}\
           --output-tables {output.tables}\
           --year {wildcards.year}\
           --version {wildcards.version}\
           --trigger {wildcards.trigger}\
           --step {wildcards.step}\
    ) &> {log}""")
    send_mail(f"Angular Acceptance Blend :: {wildcards}", f"{log}")


# naive angular acceptance - no correction (only sWeight and polWeight) --------
#     Here we have 2 rules to compute angular acceptance without correcting
#     MC samples. First rule computes angular acceptance for MC, and second one
#     merges MC results to compute RD angular acceptance
rule angular_acceptance_joinWeights:
  resources:
    mem_mb = 4096
  wildcard_constraints:
    wflag = "(angWeight|angWeightBin.*)"
  input:
    b = SAMPLES_PATH+'{year}/{mode}/{version}_{wflag}_biased.npy',
    u = SAMPLES_PATH+'{year}/{mode}/{version}_{wflag}_unbiased.npy'
  output:
    SAMPLES_PATH+'{year}/{mode}/{version}_{wflag}.root'
  run:
    import uproot3 # uproot4 recreate method not yet avaliable
    import numpy as np
    b = np.load(f"{input.b}")
    u = np.load(f"{input.u}")
    with uproot3.recreate(f"{output}") as rfile:
      rfile['DecayTree'] = uproot3.newtree({'angWeight':np.float64})
      rfile['DecayTree'].extend({'angWeight':b+u})
    rfile.close()


rule angular_acceptance_veronikaWeights:
  resources:
    mem_mb = 4096
  input:
    a = lambda wcs: tuples(wcs,weight='kkpWeight'),
    b = lambda wcs: tuples(wcs,weight='sWeight')
  output:
    SAMPLES_PATH+'{year}/{mode}/{version}_veronikaWeight.root'
  run:
    import uproot3
    import numpy as np
    a = uproot3.open(f"{input.a}")['DecayTree'].arrays()
    b = uproot3.open(f"{input.b}")['DecayTree'].arrays()
    c = {**a,**b}
    with uproot3.recreate(f"{output}") as rfile:
      rfile['DecayTree'] = uproot3.newtree( {k:np.float64 for k in c.keys()} )
      rfile['DecayTree'].extend( {k:v for k,v in c.items()} )
    rfile.close()



# Correcting MC with kinematic weights -----------------------------------------
#     Correcting MC sample with kinematic weighting in B_P, B_PT and X_M helps
#     to better match MC to RD.
rule angular_acceptance_corrected:
  resources:
    mem_mb = 4096
  wildcard_constraints:
    mode = "(MC)_(Bs2JpsiPhi|Bd2JpsiKstar)(_dG0)?",
  input:
    sample_mc = lambda wcs: tuples(wcs),
    sample_rd = lambda wcs: tuples(wcs,mode='data'),
  params:
    params = 'analysis/params/generator/{year}/{mode}.json',
  output:
    params = 'output/params/angular_acceptance/{year}/{mode}/{version}_corrected_{trigger}.json',
    tables = 'output/tables/angular_acceptance/{year}/{mode}/{version}_corrected_{trigger}.tex',
    weight = temp(SAMPLES_PATH+'{year}/{mode}/{version}_angWeight_{trigger}.npy')
  log:
    'output/log/angular_acceptance_corrected/{year}/{mode}/{version}_corrected_{trigger}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/corrected.py\
           --sample-mc {input.sample_mc}\
           --sample-data {input.sample_rd}\
           --input-params {params.params}\
           --output-params {output.params}\
           --output-tables {output.tables}\
           --output-weights-file {output.weight}\
           --mode {wildcards.mode}\
           --year {wildcards.year}\
           --version {wildcards.version}\
           --trigger {wildcards.trigger}\
    ) &> {log}""")
    send_mail(f"Angular Acceptance Corrected :: {wildcards}", f"{log}")




# Run2a angular acceptance ------------------------------------------------------
#     This rule runs the iterative procedure for all Run2 YEARS using both
#     MC and MC_dG0 files.
rule angular_acceptance_iterativeRun2a:
  resources:
    mem_mb = 16384
  wildcard_constraints:
    angacc = "run2a(shit)?"
  input:
    # Samples and weights
    sample_std = lambda wcs: tuples(wcs, mode='MC_Bs2JpsiPhi', year='run2a'),
    sample_dG0 = lambda wcs: tuples(wcs, mode='MC_Bs2JpsiPhi_dG0', year='run2a'),
    weights_std = lambda wcs: tuples(wcs, mode='MC_Bs2JpsiPhi',year='run2a', weight=f'angWeight'),
    weights_dG0 = lambda wcs: tuples(wcs, mode='MC_Bs2JpsiPhi_dG0', year='run2a', weight=f'angWeight'),
    sample_data = lambda wcs: tuples(wcs, mode='Bs2JpsiPhi', year='run2a'),
    # Angular acceptance at corrected level
    angacc_biased = [
      'output/params/angular_acceptance/2015/Bs2JpsiPhi/{version}_corrected_biased.json',
      'output/params/angular_acceptance/2016/Bs2JpsiPhi/{version}_corrected_biased.json'
    ],
    angacc_unbiased = [
      'output/params/angular_acceptance/2015/Bs2JpsiPhi/{version}_corrected_unbiased.json',
      'output/params/angular_acceptance/2016/Bs2JpsiPhi/{version}_corrected_unbiased.json'
    ],
    # Time acceptance coefficients
    timeacc_biased = [
      'output/params/time_acceptance/2015/Bd2JpsiKstar/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2016/Bd2JpsiKstar/{version}_{timeacc}_biased.json'
    ],
    timeacc_unbiased = [
      'output/params/time_acceptance/2015/Bd2JpsiKstar/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2016/Bd2JpsiKstar/{version}_{timeacc}_unbiased.json'
    ],
    # CSP
    csp_factors = lambda wcs: [
      f'output/params/csp_factors/2015/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/csp_factors/2016/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ],
    # Time resolution
    time_resolution = lambda wcs: [
      f'output/params/time_resolution/2015/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/time_resolution/2016/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ],
    # Flavor tagging
    flavor = lambda wcs: [
      f'output/params/flavor_tagging/2015/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/flavor_tagging/2016/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ]
  params:
    params_std = [
      'analysis/params/generator/2015/MC_Bs2JpsiPhi.json', # WARNING
      'analysis/params/generator/2016/MC_Bs2JpsiPhi.json'], # WARNING
    params_dG0 = [
      'analysis/params/generator/2015/MC_Bs2JpsiPhi_dG0.json', # WARNING
      'analysis/params/generator/2016/MC_Bs2JpsiPhi_dG0.json'], # WARNING
  output:
    angacc_biased = [
      'output/params/angular_acceptance/2015/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.json',
      'output/params/angular_acceptance/2016/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.json'
    ],
    angacc_unbiased = [
      'output/params/angular_acceptance/2015/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2016/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.json'
    ],
    tables_biased = [
      'output/tables/angular_acceptance/2015/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2016/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.tex'
    ],
    tables_unbiased = [
      'output/tables/angular_acceptance/2015/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2016/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.tex'
    ],
    weights_std = [
      SAMPLES_PATH+'2015/MC_Bs2JpsiPhi/{version}_{angacc}_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2016/MC_Bs2JpsiPhi/{version}_{angacc}_{timeacc}_kkpWeight.root'
    ],
    weights_dg0 = [
      SAMPLES_PATH+'2015/MC_Bs2JpsiPhi_dG0/{version}_{angacc}_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2016/MC_Bs2JpsiPhi_dG0/{version}_{angacc}_{timeacc}_kkpWeight.root'
    ],
  log:
    'output/log/angular_acceptance_iterative/{angacc}/Bs2JpsiPhi/{version}_run2a_{timeacc}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/iterative.py\
           --sample-mc-std           {",".join(input.sample_std)}\
           --sample-mc-dg0           {",".join(input.sample_dG0)}\
           --sample-data             {",".join(input.sample_data)}\
           --params-mc-std           {",".join(params.params_std)}\
           --params-mc-dg0           {",".join(params.params_dG0)}\
           --angular-weights-mc-std  {",".join(input.weights_std)}\
           --angular-weights-mc-dg0  {",".join(input.weights_dG0)}\
           --input-weights-biased    {",".join(input.angacc_biased)}\
           --input-weights-unbiased  {",".join(input.angacc_unbiased)}\
           --input-coeffs-biased     {",".join(input.timeacc_biased)}\
           --input-coeffs-unbiased   {",".join(input.timeacc_unbiased)}\
           --input-csp               {",".join(input.csp_factors)}\
           --input-time-resolution   {",".join(input.time_resolution)}\
           --input-flavor-tagging    {",".join(input.flavor)}\
           --output-weights-biased   {",".join(output.angacc_biased)}\
           --output-weights-unbiased {",".join(output.angacc_unbiased)}\
           --output-tables-biased    {",".join(output.tables_biased)}\
           --output-tables-unbiased  {",".join(output.tables_unbiased)}\
           --output-angular-weights-mc-std  {",".join(output.weights_std)}\
           --output-angular-weights-mc-dg0  {",".join(output.weights_dg0)}\
           --year                    {",".join(YEARS['Run2a'])}\
           --angacc                  {wildcards.angacc}_{wildcards.timeacc}\
           --version                 {wildcards.version}\
    ) &> {log}""")
    send_mail(f"Angular Acceptance Run2a :: {wildcards}", f"{log}")









# Run2 angular acceptance ------------------------------------------------------
#     This rule runs the iterative procedure for all Run2 YEARS using both
#     MC and MC_dG0 files.
rule angular_acceptance_iterativeRun2:
  resources:
    mem_mb = 16384
  threads: 16
  wildcard_constraints:
    angacc = "run2(shit)?"
  input:
    # Samples and weights
    sample_std = lambda wcs: tuples(wcs,mode='MC_Bs2JpsiPhi',year='Run2'),
    sample_dG0 = lambda wcs: tuples(wcs,mode='MC_Bs2JpsiPhi_dG0',year='Run2'),
    weights_std = lambda wcs: tuples(wcs,mode='MC_Bs2JpsiPhi',year='Run2',weight=f'angWeight'),
    weights_dG0 = lambda wcs: tuples(wcs,mode='MC_Bs2JpsiPhi_dG0',year='Run2',weight=f'angWeight'),
    sample_data = lambda wcs: tuples(wcs,mode='Bs2JpsiPhi',year='Run2'),
    # Angular acceptance at corrected level
    angacc_biased = [
      'output/params/angular_acceptance/2015/Bs2JpsiPhi/{version}_corrected_biased.json',
      'output/params/angular_acceptance/2016/Bs2JpsiPhi/{version}_corrected_biased.json',
      'output/params/angular_acceptance/2017/Bs2JpsiPhi/{version}_corrected_biased.json',
      'output/params/angular_acceptance/2018/Bs2JpsiPhi/{version}_corrected_biased.json'
    ],
    angacc_unbiased = [
      'output/params/angular_acceptance/2015/Bs2JpsiPhi/{version}_corrected_unbiased.json',
      'output/params/angular_acceptance/2016/Bs2JpsiPhi/{version}_corrected_unbiased.json',
      'output/params/angular_acceptance/2017/Bs2JpsiPhi/{version}_corrected_unbiased.json',
      'output/params/angular_acceptance/2018/Bs2JpsiPhi/{version}_corrected_unbiased.json'
    ],
    # Time acceptance coefficients
    timeacc_biased = [
      'output/params/time_acceptance/2015/Bd2JpsiKstar/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2016/Bd2JpsiKstar/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2017/Bd2JpsiKstar/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2018/Bd2JpsiKstar/{version}_{timeacc}_biased.json'
    ],
    timeacc_unbiased = [
      'output/params/time_acceptance/2015/Bd2JpsiKstar/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2016/Bd2JpsiKstar/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2017/Bd2JpsiKstar/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2018/Bd2JpsiKstar/{version}_{timeacc}_unbiased.json'
    ],
    # CSP
    csp_factors = lambda wcs: [
      f'output/params/csp_factors/2015/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/csp_factors/2016/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/csp_factors/2017/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/csp_factors/2018/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ],
    # Time resolution
    time_resolution = lambda wcs: [
      f'output/params/time_resolution/2015/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/time_resolution/2016/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/time_resolution/2017/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/time_resolution/2018/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ],
    # Flavor tagging
    flavor = lambda wcs: [
      f'output/params/flavor_tagging/2015/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/flavor_tagging/2016/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/flavor_tagging/2017/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/flavor_tagging/2018/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ]
  params:
    params_std = [
      'analysis/params/generator/2015/MC_Bs2JpsiPhi.json',
      'analysis/params/generator/2016/MC_Bs2JpsiPhi.json',
      'analysis/params/generator/2017/MC_Bs2JpsiPhi.json',
      'analysis/params/generator/2018/MC_Bs2JpsiPhi.json'
    ],
    params_dG0 = [
      'analysis/params/generator/2015/MC_Bs2JpsiPhi_dG0.json',
      'analysis/params/generator/2016/MC_Bs2JpsiPhi_dG0.json',
      'analysis/params/generator/2017/MC_Bs2JpsiPhi_dG0.json',
      'analysis/params/generator/2018/MC_Bs2JpsiPhi_dG0.json'
    ],
  output:
    angacc_biased = [
      'output/params/angular_acceptance/2015/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.json',
      'output/params/angular_acceptance/2016/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.json',
      'output/params/angular_acceptance/2017/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.json',
      'output/params/angular_acceptance/2018/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.json'
    ],
    angacc_unbiased = [
      'output/params/angular_acceptance/2015/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2016/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2017/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2018/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.json'
    ],
    tables_biased = [
      'output/tables/angular_acceptance/2015/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2016/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2017/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2018/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.tex'
    ],
    tables_unbiased = [
      'output/tables/angular_acceptance/2015/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2016/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2017/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2018/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.tex'
    ],
    weights_std = [
      SAMPLES_PATH+'2015/MC_Bs2JpsiPhi/{version}_{angacc}_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2016/MC_Bs2JpsiPhi/{version}_{angacc}_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2017/MC_Bs2JpsiPhi/{version}_{angacc}_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2018/MC_Bs2JpsiPhi/{version}_{angacc}_{timeacc}_kkpWeight.root',
    ],
    weights_dg0 = [
      SAMPLES_PATH+'2015/MC_Bs2JpsiPhi_dG0/{version}_{angacc}_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2016/MC_Bs2JpsiPhi_dG0/{version}_{angacc}_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2017/MC_Bs2JpsiPhi_dG0/{version}_{angacc}_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2018/MC_Bs2JpsiPhi_dG0/{version}_{angacc}_{timeacc}_kkpWeight.root',
    ],
  log:
    'output/log/angular_acceptance_iterative/{angacc}/Bs2JpsiPhi/{version}_base_{timeacc}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/iterative.py\
           --sample-mc-std           {",".join(input.sample_std)}\
           --sample-mc-dg0           {",".join(input.sample_dG0)}\
           --sample-data             {",".join(input.sample_data)}\
           --params-mc-std           {",".join(params.params_std)}\
           --params-mc-dg0           {",".join(params.params_dG0)}\
           --angular-weights-mc-std  {",".join(input.weights_std)}\
           --angular-weights-mc-dg0  {",".join(input.weights_dG0)}\
           --input-weights-biased    {",".join(input.angacc_biased)}\
           --input-weights-unbiased  {",".join(input.angacc_unbiased)}\
           --input-coeffs-biased     {",".join(input.timeacc_biased)}\
           --input-coeffs-unbiased   {",".join(input.timeacc_unbiased)}\
           --input-csp               {",".join(input.csp_factors)}\
           --input-time-resolution   {",".join(input.time_resolution)}\
           --input-flavor-tagging    {",".join(input.flavor)}\
           --output-weights-biased   {",".join(output.angacc_biased)}\
           --output-weights-unbiased {",".join(output.angacc_unbiased)}\
           --output-tables-biased    {",".join(output.tables_biased)}\
           --output-tables-unbiased  {",".join(output.tables_unbiased)}\
           --output-angular-weights-mc-std  {",".join(output.weights_std)}\
           --output-angular-weights-mc-dg0  {",".join(output.weights_dg0)}\
           --year                    {",".join(YEARS['Run2'])}\
           --angacc                  {wildcards.angacc}_{wildcards.timeacc}\
           --version                 {wildcards.version}\
    ) &> {log}""")
    send_mail(f"Angular Acceptance Run2 :: {wildcards}", f"{log}")



rule angular_acceptance_iterativeRun2Bd:
  resources:
    mem_mb = 16384
  threads: 16
  wildcard_constraints:
    angacc = "run2(shit)?"
  input:
    # Samples and weights
    sample_std = lambda wcs: tuples(wcs,mode='MC_Bd2JpsiKstar',year='Run2'),
    sample_data = lambda wcs: tuples(wcs,mode='Bd2JpsiKstar',year='Run2'),
    # CSP
    csp_factors = lambda wcs: [
      f'output/params/csp_factors/2015/Bd2JpsiKstar/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/csp_factors/2016/Bd2JpsiKstar/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/csp_factors/2017/Bd2JpsiKstar/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/csp_factors/2018/Bd2JpsiKstar/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ],
  params:
    params_std = [
      'analysis/params/generator/2015/MC_Bd2JpsiKstar.json',
      'analysis/params/generator/2016/MC_Bd2JpsiKstar.json',
      'analysis/params/generator/2017/MC_Bd2JpsiKstar.json',
      'analysis/params/generator/2018/MC_Bd2JpsiKstar.json'
    ],
  output:
    angacc_biased = [
      'output/params/angular_acceptance/2015/Bd2JpsiKstar/{version}_{angacc}_data_biased.json',
      'output/params/angular_acceptance/2016/Bd2JpsiKstar/{version}_{angacc}_data_biased.json',
      'output/params/angular_acceptance/2017/Bd2JpsiKstar/{version}_{angacc}_data_biased.json',
      'output/params/angular_acceptance/2018/Bd2JpsiKstar/{version}_{angacc}_data_biased.json'
    ],
    angacc_unbiased = [
      'output/params/angular_acceptance/2015/Bd2JpsiKstar/{version}_{angacc}_data_unbiased.json',
      'output/params/angular_acceptance/2016/Bd2JpsiKstar/{version}_{angacc}_data_unbiased.json',
      'output/params/angular_acceptance/2017/Bd2JpsiKstar/{version}_{angacc}_data_unbiased.json',
      'output/params/angular_acceptance/2018/Bd2JpsiKstar/{version}_{angacc}_data_unbiased.json'
    ],
    tables_biased = [
      'output/tables/angular_acceptance/2015/Bd2JpsiKstar/{version}_{angacc}_data_biased.tex',
      'output/tables/angular_acceptance/2016/Bd2JpsiKstar/{version}_{angacc}_data_biased.tex',
      'output/tables/angular_acceptance/2017/Bd2JpsiKstar/{version}_{angacc}_data_biased.tex',
      'output/tables/angular_acceptance/2018/Bd2JpsiKstar/{version}_{angacc}_data_biased.tex'
    ],
    tables_unbiased = [
      'output/tables/angular_acceptance/2015/Bd2JpsiKstar/{version}_{angacc}_data_unbiased.tex',
      'output/tables/angular_acceptance/2016/Bd2JpsiKstar/{version}_{angacc}_data_unbiased.tex',
      'output/tables/angular_acceptance/2017/Bd2JpsiKstar/{version}_{angacc}_data_unbiased.tex',
      'output/tables/angular_acceptance/2018/Bd2JpsiKstar/{version}_{angacc}_data_unbiased.tex'
    ],
    weights_std = [
      SAMPLES_PATH+'2015/MC_Bd2JpsiKstar/{version}_{angacc}_data_kkpWeight.root',
      SAMPLES_PATH+'2016/MC_Bd2JpsiKstar/{version}_{angacc}_data_kkpWeight.root',
      SAMPLES_PATH+'2017/MC_Bd2JpsiKstar/{version}_{angacc}_data_kkpWeight.root',
      SAMPLES_PATH+'2018/MC_Bd2JpsiKstar/{version}_{angacc}_data_kkpWeight.root',
    ],
  log:
    'output/log/angular_acceptance_iterative/run2/Bd2JpsiKstar/{version}_{angacc}_data.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/iterative_Bd.py\
           --sample-mc-std           {",".join(input.sample_std)}\
           --sample-data             {",".join(input.sample_data)}\
           --params-mc-std           {",".join(params.params_std)}\
           --input-csp               {",".join(input.csp_factors)}\
           --output-weights-biased   {",".join(output.angacc_biased)}\
           --output-weights-unbiased {",".join(output.angacc_unbiased)}\
           --output-tables-biased    {",".join(output.tables_biased)}\
           --output-tables-unbiased  {",".join(output.tables_unbiased)}\
           --output-angular-weights-mc-std  {",".join(output.weights_std)}\
           --year                    {",".join(YEARS['Run2'])}\
           --angacc                  {wildcards.angacc}\
           --version                 {wildcards.version}\
    ) &> {log}""")
    send_mail(f"Angular Acceptance Run2 Bd :: {wildcards}", f"{log}")
##Comparacion Simon Ramon
rule angular_acceptance_iterativeRun2BdSimon:
  resources:
    mem_mb=8192
  threads: 16
  wildcard_constraints:
    angacc = "run2a(shit)?"
  input:
    # Samples and weights
    sample_std = lambda wcs: tuples(wcs,mode='MC_Bd2JpsiKstar',year='Run2a'),
    sample_data = lambda wcs: tuples(wcs,mode='Bd2JpsiKstar',year='Run2a'),
    # CSP
    csp_factors = lambda wcs: [
      f'output/params/csp_factors/2015/Bd2JpsiKstar/{wcs.version.split("@")[0].split("bdt")[0]}.json',
      f'output/params/csp_factors/2016/Bd2JpsiKstar/{wcs.version.split("@")[0].split("bdt")[0]}.json',
    ],
  params:
    params_std = [
      'analysis/params/generator/2015/MC_Bd2JpsiKstar.json',
      'analysis/params/generator/2016/MC_Bd2JpsiKstar.json',
    ],
  output:
    angacc_biased = [
      'output/params/angular_acceptance/2015/Bd2JpsiKstar/{version}_{angacc}_simon_biased.json',
      'output/params/angular_acceptance/2016/Bd2JpsiKstar/{version}_{angacc}_simon_biased.json',
    ],
    angacc_unbiased = [
      'output/params/angular_acceptance/2015/Bd2JpsiKstar/{version}_{angacc}_simon_unbiased.json',
      'output/params/angular_acceptance/2016/Bd2JpsiKstar/{version}_{angacc}_simon_unbiased.json',
    ],
    tables_biased = [
      'output/tables/angular_acceptance/2015/Bd2JpsiKstar/{version}_{angacc}_simon_biased.tex',
      'output/tables/angular_acceptance/2016/Bd2JpsiKstar/{version}_{angacc}_simon_biased.tex',
    ],
    tables_unbiased = [
      'output/tables/angular_acceptance/2015/Bd2JpsiKstar/{version}_{angacc}_simon_unbiased.tex',
      'output/tables/angular_acceptance/2016/Bd2JpsiKstar/{version}_{angacc}_simon_unbiased.tex',
    ],
    weights_std = [
      SAMPLES_PATH+'2015/MC_Bd2JpsiKstar/{version}_{angacc}_simon_kkpWeight.root',
      SAMPLES_PATH+'2016/MC_Bd2JpsiKstar/{version}_{angacc}_simon_kkpWeight.root',
    ],
  log:
    'output/log/angular_acceptance_iterative/run2/Bd2JpsiKstar/{version}_{angacc}_simon.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/iterative_Bd.py\
           --sample-mc-std           {",".join(input.sample_std)}\
           --sample-data             {",".join(input.sample_data)}\
           --params-mc-std           {",".join(params.params_std)}\
           --input-csp               {",".join(input.csp_factors)}\
           --output-weights-biased   {",".join(output.angacc_biased)}\
           --output-weights-unbiased {",".join(output.angacc_unbiased)}\
           --output-tables-biased    {",".join(output.tables_biased)}\
           --output-tables-unbiased  {",".join(output.tables_unbiased)}\
           --output-angular-weights-mc-std  {",".join(output.weights_std)}\
           --year                    {",".join(YEARS['Run2a'])}\
           --angacc                  {wildcards.angacc}\
           --version                 {wildcards.version}\
    ) #&> {log}""")
    send_mail(f"Angular Acceptance Run2 Bd :: {wildcards}", f"{log}")
### Angular acceptance iterative Diego's idea
rule angular_acceptance_iterativeRun2MCBd:
  resources:
    mem_mb=8192
  threads: 16
  wildcard_constraints:
    angacc = "run2(shit)?"
  input:
    # Samples and weights
    sample_std = lambda wcs: tuples(wcs,mode='MC_Bd2JpsiKstar',year='Run2'),
    #weights_std = lambda wcs: tuples(wcs,mode='MC_Bd2JpsiKstar',year='Run2',weight=f'angWeight'),
  params:
    params_std = [
      'analysis/params/generator/2015/MC_Bd2JpsiKstar.json',
      'analysis/params/generator/2016/MC_Bd2JpsiKstar.json',
      'analysis/params/generator/2017/MC_Bd2JpsiKstar.json',
      'analysis/params/generator/2018/MC_Bd2JpsiKstar.json'
    ],
  output:
    angacc_biased = [
      'output/params/angular_acceptance/2015/Bd2JpsiKstar/{version}_{angacc}_biased.json',
      'output/params/angular_acceptance/2016/Bd2JpsiKstar/{version}_{angacc}_biased.json',
      'output/params/angular_acceptance/2017/Bd2JpsiKstar/{version}_{angacc}_biased.json',
      'output/params/angular_acceptance/2018/Bd2JpsiKstar/{version}_{angacc}_biased.json'
    ],
    angacc_unbiased = [
      'output/params/angular_acceptance/2015/Bd2JpsiKstar/{version}_{angacc}_unbiased.json',
      'output/params/angular_acceptance/2016/Bd2JpsiKstar/{version}_{angacc}_unbiased.json',
      'output/params/angular_acceptance/2017/Bd2JpsiKstar/{version}_{angacc}_unbiased.json',
      'output/params/angular_acceptance/2018/Bd2JpsiKstar/{version}_{angacc}_unbiased.json'
    ],
    tables_biased = [
      'output/tables/angular_acceptance/2015/Bd2JpsiKstar/{version}_{angacc}_biased.tex',
      'output/tables/angular_acceptance/2016/Bd2JpsiKstar/{version}_{angacc}_biased.tex',
      'output/tables/angular_acceptance/2017/Bd2JpsiKstar/{version}_{angacc}_biased.tex',
      'output/tables/angular_acceptance/2018/Bd2JpsiKstar/{version}_{angacc}_biased.tex'
    ],
    tables_unbiased = [
      'output/tables/angular_acceptance/2015/Bd2JpsiKstar/{version}_{angacc}_unbiased.tex',
      'output/tables/angular_acceptance/2016/Bd2JpsiKstar/{version}_{angacc}_unbiased.tex',
      'output/tables/angular_acceptance/2017/Bd2JpsiKstar/{version}_{angacc}_unbiased.tex',
      'output/tables/angular_acceptance/2018/Bd2JpsiKstar/{version}_{angacc}_unbiased.tex'
    ],
    weights_std = [
      SAMPLES_PATH+'2015/MC_Bd2JpsiKstar/{version}_{angacc}_kkpWeight.root',
      SAMPLES_PATH+'2016/MC_Bd2JpsiKstar/{version}_{angacc}_kkpWeight.root',
      SAMPLES_PATH+'2017/MC_Bd2JpsiKstar/{version}_{angacc}_kkpWeight.root',
      SAMPLES_PATH+'2018/MC_Bd2JpsiKstar/{version}_{angacc}_kkpWeight.root',
    ],
  log:
    'output/log/angular_acceptance_iterative/run2/Bd2JpsiKstar/{version}_{angacc}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/iterative_MC.py\
           --sample-mc-std           {",".join(input.sample_std)}\
           --params-mc-std           {",".join(params.params_std)}\
           --output-weights-biased   {",".join(output.angacc_biased)}\
           --output-weights-unbiased {",".join(output.angacc_unbiased)}\
           --output-tables-biased    {",".join(output.tables_biased)}\
           --output-tables-unbiased  {",".join(output.tables_unbiased)}\
           --output-angular-weights-mc-std  {",".join(output.weights_std)}\
           --year                    {",".join(YEARS['Run2'])}\
           --angacc                  {wildcards.angacc}_single\
           --version                 {wildcards.version}\
    ) &> {log}""")
    send_mail(f"Angular Acceptance Run2 MC :: {wildcards}", f"{log}")


# Run2 MC Bs angular acceptance ------------------------------------------------------
#     This rule runs the iterative procedure for all Run2 YEARS using both
#     MC and MC_dG0 files.
rule angular_acceptance_iterativeRun2MCBs:
  resources:
    mem_mb = 16384
  threads: 16
  wildcard_constraints:
    angacc = "run2(shit)?",
    mode = "MC_Bs2JpsiPhi(_dG0)?"
  input:
    # Samples and weights
    sample_std = lambda wcs: tuples(wcs,year='Run2'),
    # Time acceptance coefficients
    #For this check only MC_Bs_dG0 time acceptance single is needed (Diego's idea)
    timeacc_biased = [
      'output/params/time_acceptance/2015/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2016/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2017/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2018/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json'
    ],
    timeacc_unbiased = [
      'output/params/time_acceptance/2015/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2016/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2017/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2018/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json'
    ],
    time_resolution = lambda wcs: [
        f'output/params/time_resolution/2015/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json',
        f'output/params/time_resolution/2016/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json',
        f'output/params/time_resolution/2017/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json',
        f'output/params/time_resolution/2018/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ],
  params:
    params_std = [
      'analysis/params/generator/2015/{mode}.json',
      'analysis/params/generator/2016/{mode}.json',
      'analysis/params/generator/2017/{mode}.json',
      'analysis/params/generator/2018/{mode}.json'
    ],
  output:
    angacc_biased = [
      'output/params/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs_{timeacc}_biased.json',
      'output/params/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs_{timeacc}_biased.json',
      'output/params/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs_{timeacc}_biased.json',
      'output/params/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs_{timeacc}_biased.json'
    ],
    angacc_unbiased = [
      'output/params/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs_{timeacc}_unbiased.json'
    ],
    tables_biased = [
      'output/tables/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs_{timeacc}_biased.tex'
    ],
    tables_unbiased = [
      'output/tables/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs_{timeacc}_unbiased.tex'
    ],
    weights_std = [
      SAMPLES_PATH+'2015/{mode}/{version}_{angacc}MCBs_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2016/{mode}/{version}_{angacc}MCBs_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2017/{mode}/{version}_{angacc}MCBs_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2018/{mode}/{version}_{angacc}MCBs_{timeacc}_kkpWeight.root',
    ],
  log:
    'output/log/angular_acceptance_iterative/run2/{mode}/{version}_{angacc}MCBs_{timeacc}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/iterative_MCBs.py\
           --sample-mc-std           {",".join(input.sample_std)}\
           --params-mc-std           {",".join(params.params_std)}\
           --input-coeffs-biased     {",".join(input.timeacc_biased)}\
           --input-coeffs-unbiased   {",".join(input.timeacc_unbiased)}\
           --input-time-resolution   {",".join(input.time_resolution)}\
           --output-weights-biased   {",".join(output.angacc_biased)}\
           --output-weights-unbiased {",".join(output.angacc_unbiased)}\
           --output-tables-biased    {",".join(output.tables_biased)}\
           --output-tables-unbiased  {",".join(output.tables_unbiased)}\
           --output-angular-weights-mc-std  {",".join(output.weights_std)}\
           --year                    {",".join(YEARS['Run2'])}\
           --angacc                  {wildcards.angacc}_{wildcards.timeacc}\
           --version                 {wildcards.version}\
           --mode                    {wildcards.mode}\
    ) &> {log}""")
    send_mail(f"Angular Acceptance Run2 MC Bs :: {wildcards}", f"{log}")

# Run2 MC Bs angular acceptance ------------------------------------------------------
#     This rule runs the iterative procedure for all Run2 YEARS using both
#     MC and MC_dG0 files.
rule angular_acceptance_iterativeRun2MCBs2:
  resources:
    mem_mb = 16384
  threads: 16
  wildcard_constraints:
    angacc = "run2(shit)?",
    mode = "MC_Bs2JpsiPhi(_dG0)?"
  input:
    # Samples and weights
    sample_std = lambda wcs: tuples(wcs,year='Run2'),
    # Time acceptance coefficients
    #For this check only MC_Bs_dG0 time acceptance single is needed (Diego's idea)
    timeacc_biased = [
      'output/params/time_acceptance/2015/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2016/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2017/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2018/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json'
    ],
    timeacc_unbiased = [
      'output/params/time_acceptance/2015/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2016/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2017/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2018/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json'
    ],
    time_resolution = lambda wcs: [
        f'output/params/time_resolution/2015/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json',
        f'output/params/time_resolution/2016/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json',
        f'output/params/time_resolution/2017/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json',
        f'output/params/time_resolution/2018/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ],
  params:
    params_std = [
      'analysis/params/generator/2015/{mode}.json',
      'analysis/params/generator/2016/{mode}.json',
      'analysis/params/generator/2017/{mode}.json',
      'analysis/params/generator/2018/{mode}.json'
    ],
  output:
    angacc_biased = [
      'output/params/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs2_{timeacc}_biased.json',
      'output/params/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs2_{timeacc}_biased.json',
      'output/params/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs2_{timeacc}_biased.json',
      'output/params/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs2_{timeacc}_biased.json'
    ],
    angacc_unbiased = [
      'output/params/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs2_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs2_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs2_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs2_{timeacc}_unbiased.json'
    ],
    tables_biased = [
      'output/tables/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs2_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs2_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs2_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs2_{timeacc}_biased.tex'
    ],
    tables_unbiased = [
      'output/tables/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs2_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs2_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs2_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs2_{timeacc}_unbiased.tex'
    ],
    weights_std = [
      SAMPLES_PATH+'2015/{mode}/{version}_{angacc}MCBs2_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2016/{mode}/{version}_{angacc}MCBs2_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2017/{mode}/{version}_{angacc}MCBs2_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2018/{mode}/{version}_{angacc}MCBs2_{timeacc}_kkpWeight.root',
    ],
  log:
    'output/log/angular_acceptance_iterative/run2/{mode}/{version}_{angacc}MCBs2_{timeacc}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/iterative_MCBs2.py\
           --sample-mc-std           {",".join(input.sample_std)}\
           --params-mc-std           {",".join(params.params_std)}\
           --input-coeffs-biased     {",".join(input.timeacc_biased)}\
           --input-coeffs-unbiased   {",".join(input.timeacc_unbiased)}\
           --input-time-resolution   {",".join(input.time_resolution)}\
           --output-weights-biased   {",".join(output.angacc_biased)}\
           --output-weights-unbiased {",".join(output.angacc_unbiased)}\
           --output-tables-biased    {",".join(output.tables_biased)}\
           --output-tables-unbiased  {",".join(output.tables_unbiased)}\
           --output-angular-weights-mc-std  {",".join(output.weights_std)}\
           --year                    {",".join(YEARS['Run2'])}\
           --angacc                  {wildcards.angacc}_{wildcards.timeacc}\
           --version                 {wildcards.version}\
           --mode                    {wildcards.mode}\
    ) &> {log}""")
    send_mail(f"Angular Acceptance Run2 MC Bs :: {wildcards}", f"{log}")


# Run2 MC Bs angular acceptance ------------------------------------------------------
#     This rule runs the iterative procedure for all Run2 YEARS using both
#     MC and MC_dG0 files.
rule angular_acceptance_iterativeRun2MCBs3:
  resources:
    mem_mb = 16384
  threads: 16
  wildcard_constraints:
    angacc = "run2(shit)?",
    mode = "MC_Bs2JpsiPhi(_dG0)?"
  input:
    # Samples and weights
    sample_std = lambda wcs: tuples(wcs,year='Run2'),
    # Time acceptance coefficients
    #For this check only MC_Bs_dG0 time acceptance single is needed (Diego's idea)
    timeacc_biased = [
      'output/params/time_acceptance/2015/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2016/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2017/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2018/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json'
    ],
    timeacc_unbiased = [
      'output/params/time_acceptance/2015/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2016/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2017/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2018/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json'
    ],
    time_resolution = lambda wcs: [
        f'output/params/time_resolution/2015/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json',
        f'output/params/time_resolution/2016/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json',
        f'output/params/time_resolution/2017/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json',
        f'output/params/time_resolution/2018/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ],
  params:
    params_std = [
      'analysis/params/generator/2015/{mode}.json',
      'analysis/params/generator/2016/{mode}.json',
      'analysis/params/generator/2017/{mode}.json',
      'analysis/params/generator/2018/{mode}.json'
    ],
  output:
    angacc_biased = [
      'output/params/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs3_{timeacc}_biased.json',
      'output/params/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs3_{timeacc}_biased.json',
      'output/params/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs3_{timeacc}_biased.json',
      'output/params/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs3_{timeacc}_biased.json'
    ],
    angacc_unbiased = [
      'output/params/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs3_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs3_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs3_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs3_{timeacc}_unbiased.json'
    ],
    tables_biased = [
      'output/tables/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs3_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs3_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs3_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs3_{timeacc}_biased.tex'
    ],
    tables_unbiased = [
      'output/tables/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs3_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs3_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs3_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs3_{timeacc}_unbiased.tex'
    ],
    weights_std = [
      SAMPLES_PATH+'2015/{mode}/{version}_{angacc}MCBs3_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2016/{mode}/{version}_{angacc}MCBs3_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2017/{mode}/{version}_{angacc}MCBs3_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2018/{mode}/{version}_{angacc}MCBs3_{timeacc}_kkpWeight.root',
    ],
  log:
    'output/log/angular_acceptance_iterative/run2/{mode}/{version}_{angacc}MCBs3_{timeacc}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/iterative_MCBs3.py\
           --sample-mc-std           {",".join(input.sample_std)}\
           --params-mc-std           {",".join(params.params_std)}\
           --input-coeffs-biased     {",".join(input.timeacc_biased)}\
           --input-coeffs-unbiased   {",".join(input.timeacc_unbiased)}\
           --input-time-resolution   {",".join(input.time_resolution)}\
           --output-weights-biased   {",".join(output.angacc_biased)}\
           --output-weights-unbiased {",".join(output.angacc_unbiased)}\
           --output-tables-biased    {",".join(output.tables_biased)}\
           --output-tables-unbiased  {",".join(output.tables_unbiased)}\
           --output-angular-weights-mc-std  {",".join(output.weights_std)}\
           --year                    {",".join(YEARS['Run2'])}\
           --angacc                  {wildcards.angacc}_{wildcards.timeacc}\
           --version                 {wildcards.version}\
           --mode                    {wildcards.mode}\
    ) &> {log}""")
    send_mail(f"Angular Acceptance Run2 MC Bs :: {wildcards}", f"{log}")


# Run2 MC Bs angular acceptance ------------------------------------------------------
#     This rule runs the iterative procedure for all Run2 YEARS using both
#     MC and MC_dG0 files.
rule angular_acceptance_iterativeRun2MCBs4:
  resources:
    mem_mb = 16384
  threads: 16
  wildcard_constraints:
    angacc = "run2(shit)?",
    mode = "MC_Bs2JpsiPhi(_dG0)?"
  input:
    # Samples and weights
    sample_std = lambda wcs: tuples(wcs,year='Run2'),
    # Time acceptance coefficients
    #For this check only MC_Bs_dG0 time acceptance single is needed (Diego's idea)
    timeacc_biased = [
      'output/params/time_acceptance/2015/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2016/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2017/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json',
      'output/params/time_acceptance/2018/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_biased.json'
    ],
    timeacc_unbiased = [
      'output/params/time_acceptance/2015/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2016/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2017/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json',
      'output/params/time_acceptance/2018/MC_Bs2JpsiPhi_dG0/{version}_{timeacc}_unbiased.json'
    ],
    time_resolution = lambda wcs: [
        f'output/params/time_resolution/2015/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json',
        f'output/params/time_resolution/2016/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json',
        f'output/params/time_resolution/2017/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json',
        f'output/params/time_resolution/2018/{wcs.mode}/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ],
  params:
    params_std = [
      'analysis/params/generator/2015/{mode}.json',
      'analysis/params/generator/2016/{mode}.json',
      'analysis/params/generator/2017/{mode}.json',
      'analysis/params/generator/2018/{mode}.json'
    ],
  output:
    angacc_biased = [
      'output/params/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs4_{timeacc}_biased.json',
      'output/params/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs4_{timeacc}_biased.json',
      'output/params/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs4_{timeacc}_biased.json',
      'output/params/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs4_{timeacc}_biased.json'
    ],
    angacc_unbiased = [
      'output/params/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs4_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs4_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs4_{timeacc}_unbiased.json',
      'output/params/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs4_{timeacc}_unbiased.json'
    ],
    tables_biased = [
      'output/tables/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs4_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs4_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs4_{timeacc}_biased.tex',
      'output/tables/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs4_{timeacc}_biased.tex'
    ],
    tables_unbiased = [
      'output/tables/angular_acceptance/2015/{mode}/{version}_{angacc}MCBs4_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2016/{mode}/{version}_{angacc}MCBs4_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2017/{mode}/{version}_{angacc}MCBs4_{timeacc}_unbiased.tex',
      'output/tables/angular_acceptance/2018/{mode}/{version}_{angacc}MCBs4_{timeacc}_unbiased.tex'
    ],
    weights_std = [
      SAMPLES_PATH+'2015/{mode}/{version}_{angacc}MCBs4_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2016/{mode}/{version}_{angacc}MCBs4_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2017/{mode}/{version}_{angacc}MCBs4_{timeacc}_kkpWeight.root',
      SAMPLES_PATH+'2018/{mode}/{version}_{angacc}MCBs4_{timeacc}_kkpWeight.root',
    ],
  log:
    'output/log/angular_acceptance_iterative/run2/{mode}/{version}_{angacc}MCBs4_{timeacc}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/iterative_MCBs4.py\
           --sample-mc-std           {",".join(input.sample_std)}\
           --params-mc-std           {",".join(params.params_std)}\
           --input-coeffs-biased     {",".join(input.timeacc_biased)}\
           --input-coeffs-unbiased   {",".join(input.timeacc_unbiased)}\
           --input-time-resolution   {",".join(input.time_resolution)}\
           --output-weights-biased   {",".join(output.angacc_biased)}\
           --output-weights-unbiased {",".join(output.angacc_unbiased)}\
           --output-tables-biased    {",".join(output.tables_biased)}\
           --output-tables-unbiased  {",".join(output.tables_unbiased)}\
           --output-angular-weights-mc-std  {",".join(output.weights_std)}\
           --year                    {",".join(YEARS['Run2'])}\
           --angacc                  {wildcards.angacc}_{wildcards.timeacc}\
           --version                 {wildcards.version}\
           --mode                    {wildcards.mode}\
    ) #&> {log}""")
    send_mail(f"Angular Acceptance Run2 MC Bs :: {wildcards}", f"{log}")
# Yearly angular acceptance ------------------------------------------------------
#     This rule runs the iterative procedure for only one year using both
#     MC and MC_dG0 files.
rule angular_acceptance_iterativeYearly:
  wildcard_constraints:
    year = "\d{4}",
    angacc = "yearly(shit)?"
  threads: 8
  input:
    sample_std = lambda wcs: [tuples(wcs,mode='MC_Bs2JpsiPhi')],
    sample_dG0 = lambda wcs: [tuples(wcs,mode='MC_Bs2JpsiPhi_dG0')],
    weights_std = lambda wcs: [tuples(wcs,mode='MC_Bs2JpsiPhi',weight=f'angWeight')],
    weights_dG0 = lambda wcs: [tuples(wcs,mode='MC_Bs2JpsiPhi_dG0',weight=f'angWeight')],
    sample_data = lambda wcs: [tuples(wcs,mode='Bs2JpsiPhi')],
    # Angular acceptance at corrected level
    angacc_biased = [
      'output/params/angular_acceptance/{year}/Bs2JpsiPhi/{version}_corrected_biased.json'
    ],
    angacc_unbiased = [
      'output/params/angular_acceptance/{year}/Bs2JpsiPhi/{version}_corrected_unbiased.json'
    ],
    # Time acceptance coefficients
    timeacc_biased = [
      'output/params/time_acceptance/{year}/Bd2JpsiKstar/{version}_{timeacc}_biased.json'
    ],
    timeacc_unbiased = [
      'output/params/time_acceptance/{year}/Bd2JpsiKstar/{version}_{timeacc}_unbiased.json'
    ],
    # CSP
    csp_factors = lambda wcs: [
      f'output/params/csp_factors/{wcs.year}/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ],
    # Time resolution
    time_resolution = lambda wcs: [
      f'output/params/time_resolution/{wcs.year}/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ],
    # Flavor tagging
    flavor = lambda wcs: [
      f'output/params/flavor_tagging/{wcs.year}/Bs2JpsiPhi/{wcs.version.split("@")[0].split("bdt")[0]}.json'
    ]
  params:
    params_std = [
      'analysis/params/generator/{year}/MC_Bs2JpsiPhi.json'
    ],
    params_dG0 = [
      'analysis/params/generator/{year}/MC_Bs2JpsiPhi_dG0.json'
    ],
  output:
    angacc_biased   = [
      'output/params/angular_acceptance/{year}/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.json'
    ],
    angacc_unbiased = [
      'output/params/angular_acceptance/{year}/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.json'
    ],
    tables_biased   = [
      'output/tables/angular_acceptance/{year}/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_biased.json'
    ],
    tables_unbiased = [
      'output/tables/angular_acceptance/{year}/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_unbiased.json'
    ],
    weights_std = [
      SAMPLES_PATH+'{year}/MC_Bs2JpsiPhi/{version}_{angacc}_{timeacc}_kkpWeight.root'
    ],
    weights_dg0 = [
      SAMPLES_PATH+'{year}/MC_Bs2JpsiPhi_dG0/{version}_{angacc}_{timeacc}_kkpWeight.root'
    ],
  log:
    'output/log/angular_acceptance_iterative/{year}/Bs2JpsiPhi/{version}_{angacc}_{timeacc}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/iterative.py\
           --sample-mc-std                  {",".join(input.sample_std)}\
           --sample-mc-dg0                  {",".join(input.sample_dG0)}\
           --sample-data                    {",".join(input.sample_data)}\
           --params-mc-std                  {",".join(params.params_std)}\
           --params-mc-dg0                  {",".join(params.params_dG0)}\
           --angular-weights-mc-std         {",".join(input.weights_std)}\
           --angular-weights-mc-dg0         {",".join(input.weights_dG0)}\
           --input-weights-biased           {",".join(input.angacc_biased)}\
           --input-weights-unbiased         {",".join(input.angacc_unbiased)}\
           --input-coeffs-biased            {",".join(input.timeacc_biased)}\
           --input-coeffs-unbiased          {",".join(input.timeacc_unbiased)}\
           --input-csp                      {",".join(input.csp_factors)}\
           --input-time-resolution          {",".join(input.time_resolution)}\
           --input-flavor-tagging           {",".join(input.flavor)}\
           --output-weights-biased          {",".join(output.angacc_biased)}\
           --output-weights-unbiased        {",".join(output.angacc_unbiased)}\
           --output-tables-biased           {",".join(output.tables_biased)}\
           --output-tables-unbiased         {",".join(output.tables_unbiased)}\
           --output-angular-weights-mc-std  {",".join(output.weights_std)}\
           --output-angular-weights-mc-dg0  {",".join(output.weights_dg0)}\
           --year                           {",".join([wildcards.year])}\
           --angacc                         {wildcards.angacc}_{wildcards.timeacc}\
           --version                        {wildcards.version}\
    ) #&> {log}""")
    send_mail(f"Angular Acceptance Yearly :: {wildcards}", f"{log}")



# Yearly angular acceptance ------------------------------------------------------
#     This rule runs the iterative procedure for only one year using both
#     MC and MC_dG0 files.
rule angular_acceptance_compareCuts:
  input:
    params = lambda wcs: [
                f'output/params/angular_acceptance/{wcs.year}/{wcs.mode}/{wcs.version}_{wcs.angacc}_{wcs.timeacc}_{wcs.trigger}.json'] +
               [f'output/params/angular_acceptance/{wcs.year}/{wcs.mode}/{wcs.version}@cut{wcs.variable}{i}_{wcs.angacc}_{wcs.timeacc}_{wcs.trigger}.json' for i in range(1,5 if f'{wcs.variable}'=='pt' else 4)
            ]
  output:
    'output/figures/angular_acceptance/{year}/{mode}/{version}@cut{variable}_{angacc}_{timeacc}_{trigger}.pdf',
  log:
    'output/log/angular_acceptance_plot/{year}/{mode}/{version}@cut{variable}_{angacc}_{timeacc}_{trigger}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/plot_binned_weights.py\
           --params {",".join(input.params)}\
           --figure {output}\
           --mode {wildcards.mode}\
           --version {wildcards.version}\
           --trigger {wildcards.trigger}\
           --year {wildcards.year}\
           --variable {wildcards.variable}\
    ) &> {log}""")
    send_mail(f"Angular Acceptance Comparison :: {wildcards}", f"{log}", [f"{output}"])



rule angular_weights_time_dependence:
  resources:
    mem_mb = 8192
  input:
    sample_std = lambda wcs: tuples(wcs,mode='MC_Bs2JpsiPhi'),
    sample_dg0 = lambda wcs: tuples(wcs,mode='MC_Bs2JpsiPhi_dG0'),
    weights_std = lambda wcs: tuples(wcs,mode='MC_Bs2JpsiPhi',weight=f'kkpWeight'),
    weights_dg0 = lambda wcs: tuples(wcs,mode='MC_Bs2JpsiPhi_dG0',weight=f'kkpWeight'),
    timeacc = 'output/params/time_acceptance/{year}/Bd2JpsiKstar/{version}_{timeacc}_{trigger}.json',
    angacc = 'output/params/angular_acceptance/{year}/Bs2JpsiPhi/{version}_{angacc}_{timeacc}_{trigger}.json',
  params:
    params_std = 'analysis/params/generator/{year}/MC_Bs2JpsiPhi.json',
    params_dg0 = 'analysis/params/generator/{year}/MC_Bs2JpsiPhi_dG0.json'
  output:
    figure = 'output/figures/angular_acceptance/{year}/{mode}/{version}_{angacc}Timedep_{timeacc}_{trigger}.pdf',
  log:
    'output/log/angular_weights_time_dependence/{year}/{mode}/{version}_{angacc}_{timeacc}_{trigger}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/time_dependence.py\
           --sample-std             {input.sample_std}\
           --sample-dg0             {input.sample_dg0}\
           --params-std             {params.params_std}\
           --params-dg0             {params.params_dg0}\
           --kkpweight-std          {input.weights_std}\
           --kkpweight-dg0          {input.weights_dg0}\
           --angacc                 {input.angacc}\
           --timeacc                 {input.timeacc}\
           --figure                 {output.figure}\
           --mode                   {wildcards.mode}\
           --version                {wildcards.version}\
           --trigger                {wildcards.trigger}\
           --year                   {wildcards.year}\
           --shit                   {wildcards.angacc}_{wildcards.timeacc}\
    ) &> {log}""")
    send_mail(f"Angular Acceptance Time Dependence :: {wildcards}", f"{log}", [f"{output}"])



rule angular_efficiency_time_dependence:
  resources:
    mem_mb = 8192
  input:
    samples = lambda wcs: tuples(wcs),
    #weights = lambda wcs: tuples(wcs,weight=f'kkpWeight'),
    angacc0 = ['output/params/angular_acceptance/{year}/{mode}/{version}_{angacc}_{timeacc}.json'],
    angacci = lambda wcs: expand('output/params/angular_acceptance/{{year}}/{{mode}}/{{version}}_{{angacc}}{{nknots}}knots{bin}_{{timeacc}}.json', bin=range(1,int(f'{wcs.nknots}')+2)),
  params:
    'analysis/params/generator/{year}/{mode}.json',
  output:
    'output/figures/angular_acceptance/{year}/{mode}/{version}_{angacc}{nknots}knots_{timeacc}_cosK.pdf',
    'output/figures/angular_acceptance/{year}/{mode}/{version}_{angacc}{nknots}knots_{timeacc}_cosL.pdf',
    'output/figures/angular_acceptance/{year}/{mode}/{version}_{angacc}{nknots}knots_{timeacc}_hphi.pdf',
  log:
    'output/log/angular_efficiency_time_dependence/{year}/{mode}/{version}_{angacc}{nknots}knots_{timeacc}.log'
  run:
    shell(f"""(time\
    python analysis/angular_acceptance/angular_acceptance_plot_veronika.py\
           --samples                {input.samples}\
           --angular_acceptance     {",".join(input.angacc0+input.angacci)}\
           --params                 {params}\
           --output                 {",".join(output)}\
           --angacc                 {wildcards.angacc}\
           --timeacc                {wildcards.timeacc.split('_')[0] if len(wildcards.angacc.split('_'))>1 else 'none'}\
           --mode                   {wildcards.mode}\
           --version                {wildcards.version}\
           --trigger                {wildcards.timeacc.split('_')[-1]}\
           --year                   {wildcards.year}\
           --nknots                 {wildcards.nknots}\
    ) &> {log}""")
    send_mail(f"Angular Acceptance Time Dependence :: {wildcards}", f"{log}", [f"{output}"])
